<div class="bg-gray-50 min-h-screen flex flex-col">
  <!-- Header -->
  <div class="bg-white shadow px-4 sm:px-6 py-3 flex items-center gap-3">
    <a routerLink="/messages" class="text-gray-500 hover:text-gray-700">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
    </a>
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center">
        <span class="text-indigo-600 font-semibold">{{ otherUserName().charAt(0).toUpperCase() || '?' }}</span>
      </div>
      <h1 class="text-lg font-semibold text-gray-900">{{ otherUserName() || 'Conversation' }}</h1>
    </div>
  </div>

  <!-- Loading -->
  @if (loading()) {
    <div class="flex-1 flex justify-center items-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
    </div>
  }

  <!-- Error -->
  @if (error()) {
    <div class="mx-4 mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
      {{ error() }}
    </div>
  }

  <!-- Messages -->
  @if (!loading()) {
    <div #messagesContainer class="flex-1 overflow-y-auto px-4 sm:px-6 py-4 space-y-2" style="max-height: calc(100vh - 160px);">
      @if (messages().length === 0) {
        <div class="text-center py-12">
          <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
          </svg>
          <p class="text-gray-500">No messages yet. Send the first message!</p>
        </div>
      }

      @for (message of messages(); track message.id; let i = $index) {
        <!-- Date Header -->
        @if (shouldShowDateHeader(i)) {
          <div class="flex justify-center my-4">
            <span class="bg-gray-200 text-gray-600 text-xs px-3 py-1 rounded-full">
              {{ formatDateHeader(message.createdAt) }}
            </span>
          </div>
        }

        <!-- Message Bubble -->
        <div class="flex" [class.justify-end]="isOwnMessage(message)" [class.justify-start]="!isOwnMessage(message)">
          <div
            class="max-w-[75%] sm:max-w-[60%] rounded-2xl px-4 py-2"
            [class.bg-indigo-600]="isOwnMessage(message)"
            [class.text-white]="isOwnMessage(message)"
            [class.rounded-br-md]="isOwnMessage(message)"
            [class.bg-white]="!isOwnMessage(message)"
            [class.text-gray-900]="!isOwnMessage(message)"
            [class.rounded-bl-md]="!isOwnMessage(message)"
            [class.shadow]="!isOwnMessage(message)"
          >
            <p class="text-sm whitespace-pre-wrap break-words">{{ message.content }}</p>
            <p
              class="text-xs mt-1"
              [class.text-indigo-200]="isOwnMessage(message)"
              [class.text-gray-400]="!isOwnMessage(message)"
            >
              {{ formatTime(message.createdAt) }}
              @if (isOwnMessage(message) && message.isRead) {
                <span class="ml-1">Read</span>
              }
            </p>
          </div>
        </div>
      }
    </div>

    <!-- Message Input -->
    <div class="bg-white border-t border-gray-200 px-4 sm:px-6 py-3">
      <div class="max-w-3xl mx-auto flex items-end gap-3">
        <div class="flex-1">
          <textarea
            [(ngModel)]="newMessage"
            (keydown)="onKeyDown($event)"
            placeholder="Type a message..."
            rows="1"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-2xl resize-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
            [disabled]="sending()"
          ></textarea>
        </div>
        <button
          (click)="sendMessage()"
          [disabled]="!newMessage.trim() || sending()"
          class="flex-shrink-0 p-2.5 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          @if (sending()) {
            <div class="w-5 h-5 animate-spin rounded-full border-2 border-white border-t-transparent"></div>
          } @else {
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
          }
        </button>
      </div>
    </div>
  }
</div>
